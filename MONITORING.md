# üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ScheduleBot

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: **Grafana + Loki + Prometheus**.

## üéØ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **Prometheus** - –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
- –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞
- –≠–Ω–¥–ø–æ–∏–Ω—Ç: `http://localhost:9090`
- Retention: 30 –¥–Ω–µ–π

### 2. **Loki** - –°–±–æ—Ä –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ª–æ–≥–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ `logs/bot.log`
- –≠–Ω–¥–ø–æ–∏–Ω—Ç: `http://localhost:3100`
- Retention: 31 –¥–µ–Ω—å

### 3. **Promtail** - –ê–≥–µ–Ω—Ç —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤
- –ß–∏—Ç–∞–µ—Ç –ª–æ–≥–∏ –∏–∑ —Ñ–∞–π–ª–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Loki
- –ü–∞—Ä—Å–∏—Ç JSON —Ñ–æ—Ä–º–∞—Ç –æ—Ç loguru

### 4. **Grafana** - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–≥–æ–≤
- –≠–Ω–¥–ø–æ–∏–Ω—Ç: `http://localhost:3000`
- –õ–æ–≥–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `admin` / `admin`

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ —Å—Ç–µ–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
cd python_bot
docker-compose up -d
```

–ë—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:
- `schedulebot` - Telegram –±–æ—Ç
- `postgres` - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- `prometheus` - –ú–µ—Ç—Ä–∏–∫–∏
- `loki` - –õ–æ–≥–∏
- `promtail` - –ê–≥–µ–Ω—Ç –ª–æ–≥–æ–≤
- `grafana` - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### 2. –î–æ—Å—Ç—É–ø –∫ Grafana

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:3000
2. –í–æ–π–¥–∏—Ç–µ —Å credentials (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`/`admin`)
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Dashboards** ‚Üí **ScheduleBot Overview**

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–æ–ª—è Grafana (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
```bash
GRAFANA_USER=admin
GRAFANA_PASSWORD=your_secure_password
```

---

## üìà –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø |
|---------|----------|-----|
| `bot_messages_total` | –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π | Counter |
| `bot_commands_total` | –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã | Counter |
| `bot_callbacks_total` | Callback –∑–∞–ø—Ä–æ—Å—ã | Counter |
| `bot_errors_total` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ | Counter |
| `bot_request_duration_seconds` | –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ | Histogram |
| `bot_unique_users_total` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | Gauge |
| `bot_active_users` | –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | Gauge |

### üíº –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏

> **üìå –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ú–µ—Ç—Ä–∏–∫–∏ retention –∏ churn —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ–ª–µ `last_activity` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–∞—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø |
|---------|----------|-----|
| **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** | | |
| `bot_daily_active_users` | DAU - –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞ 24 —á–∞—Å–∞ | Gauge |
| `bot_weekly_active_users` | WAU - –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞ 7 –¥–Ω–µ–π | Gauge |
| `bot_monthly_active_users` | MAU - –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞ 30 –¥–Ω–µ–π | Gauge |
| `bot_new_users_today` | –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è | Gauge |
| `bot_new_users_total` | –í—Å–µ–≥–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | Counter |
| **Engagement** | | |
| `bot_user_sessions_total` | –°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ç–∏–ø–∞–º | Counter |
| `bot_messages_per_user` | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | Histogram |
| `bot_commands_per_user` | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | Histogram |
| `bot_active_users_by_hour` | –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º —Å—É—Ç–æ–∫ | Gauge |
| **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** | | |
| `bot_feature_usage_total` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π | Counter |
| `bot_notification_subscribers` | –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | Gauge |
| **–ö–æ–Ω–≤–µ—Ä—Å–∏—è** | | |
| `bot_tutorial_completion_rate` | % –∑–∞–≤–µ—Ä—à–∏–≤—à–∏—Ö –æ–±—É—á–µ–Ω–∏–µ | Gauge |
| `bot_group_selection_rate` | % –≤—ã–±—Ä–∞–≤—à–∏—Ö –≥—Ä—É–ø–ø—É | Gauge |
| **Retention & Churn** | | |
| `bot_returning_users_daily` | –í–µ—Ä–Ω—É–≤—à–∏–µ—Å—è –∑–∞ 24h (–ø–æ last_activity) | Gauge |
| `bot_returning_users_weekly` | –í–µ—Ä–Ω—É–≤—à–∏–µ—Å—è –∑–∞ 7d (–ø–æ last_activity) | Gauge |
| `bot_blocked_users_total` | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞ | Gauge |
| `bot_inactive_users_7d` | –ù–µ–∞–∫—Ç–∏–≤–Ω—ã 7+ –¥–Ω–µ–π (–ø–æ last_activity) | Gauge |
| `bot_inactive_users_30d` | –ù–µ–∞–∫—Ç–∏–≤–Ω—ã 30+ –¥–Ω–µ–π (–ø–æ last_activity) | Gauge |
| **–ì—Ä—É–ø–ø—ã –∏ —á–∞—Ç—ã** | | |
| `bot_total_private_chats` | –õ–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ | Gauge |
| `bot_total_group_chats` | –ì—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤ | Gauge |
| `bot_groups_by_type` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º | Gauge |
| **Feedback** | | |
| `bot_feedback_messages_total` | –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π —Ñ–∏–¥–±–µ–∫–∞ | Counter |
| `bot_feedback_daily` | –§–∏–¥–±–µ–∫ –∑–∞ 24h | Gauge |

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (PromQL)

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏

**–°–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É:**
```promql
sum(rate(bot_messages_total{status="processed"}[5m])) * 60
```

**95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞:**
```promql
histogram_quantile(0.95, sum(rate(bot_request_duration_seconds_bucket[5m])) by (le))
```

**–¢–æ–ø –∫–æ–º–∞–Ω–¥:**
```promql
topk(5, sum(rate(bot_commands_total{status="success"}[5m])) by (command))
```

**Error rate:**
```promql
sum(rate(bot_errors_total[5m])) * 60
```

#### –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏

**DAU/WAU —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ (Stickiness):**
```promql
(bot_daily_active_users / bot_weekly_active_users) * 100
```

**–¢–æ–ø-5 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:**
```promql
topk(5, sum(increase(bot_feature_usage_total[24h])) by (feature))
```

**–†–æ—Å—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é:**
```promql
increase(bot_new_users_total[7d])
```

**Conversion rate (group selection):**
```promql
bot_group_selection_rate
```

**Churn rate (–ø—Ä–∏–º–µ—Ä–Ω—ã–π):**
```promql
(bot_blocked_users_total / bot_total_private_chats) * 100
```

**Engagement score (—Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):**
```promql
sum(rate(bot_messages_total[24h])) / bot_daily_active_users
```

**Peak hour (—á–∞—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é):**
```promql
max_over_time(bot_active_users_by_hour[24h])
```

---

## üîç –†–∞–±–æ—Ç–∞ —Å –ª–æ–≥–∞–º–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ Grafana

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Explore**
2. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö **Loki**
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ LogQL –∑–∞–ø—Ä–æ—Å—ã:

**–í—Å–µ –ª–æ–≥–∏ –±–æ—Ç–∞:**
```logql
{job="schedulebot"}
```

**–¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏:**
```logql
{job="schedulebot"} |= "ERROR"
```

**–õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:**
```logql
{job="schedulebot", function="handle_start"}
```

**–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É:**
```logql
{job="schedulebot"} |= "Failed to"
```

**–° —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —É—Ä–æ–≤–Ω—é:**
```logql
{job="schedulebot", level="ERROR"}
```

### –§–æ—Ä–º–∞—Ç—ã –ª–æ–≥–æ–≤

–ë–æ—Ç –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:
- **–ö–æ–Ω—Å–æ–ª—å (stdout)**: –ö—Ä–∞—Å–∏–≤—ã–π —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç
- **–§–∞–π–ª (logs/bot.log)**: JSON —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ Loki

---

## üìä –ì–æ—Ç–æ–≤—ã–µ –¥–∞—à–±–æ—Ä–¥—ã

### 1. **ScheduleBot Overview** (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π)

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

1. **–í–µ—Ä—Ö–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ (Stat)**
   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
   - –°–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
   - –û—à–∏–±–æ–∫ –≤ –º–∏–Ω—É—Ç—É
   - 95% –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞

2. **–ì—Ä–∞—Ñ–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤**
   - –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º (text/media)
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
   - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (p50, p95, p99)
   - –û—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º

### 2. **ScheduleBot Business Metrics** (–ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏)

–ë–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

**üìä –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏**
- DAU / WAU / MAU
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è
- –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Feedback –∑–∞ 24h

**üìà –†–æ—Å—Ç –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**
- –ì—Ä–∞—Ñ–∏–∫ DAU/WAU/MAU
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**üéØ Engagement & Retention**
- Tutorial Completion Rate (gauge)
- Group Selection Rate (gauge)
- –°–µ—Å—Å–∏–∏ –ø–æ —Ç–∏–ø–∞–º —á–∞—Ç–æ–≤ (pie chart)
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º (bar chart)

**üé® –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π**
- –ì—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –¢–æ–ø-10 —Ñ—É–Ω–∫—Ü–∏–π –∑–∞ 24h (pie chart)

**üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –≥—Ä—É–ø–ø—ã**
- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø-15 –≥—Ä—É–ø–ø
- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**‚ö†Ô∏è Churn & Health**
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞
- –ù–µ–∞–∫—Ç–∏–≤–Ω—ã 7+ –∏ 30+ –¥–Ω–µ–π
- –î–∏–Ω–∞–º–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Prometheus

–ö–æ–Ω—Ñ–∏–≥: `monitoring/prometheus.yml`

```yaml
scrape_configs:
  - job_name: 'schedulebot'
    static_configs:
      - targets: ['bot:8000']
    scrape_interval: 10s
```

### Loki

–ö–æ–Ω—Ñ–∏–≥: `monitoring/loki-config.yml`

–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- Retention: 31 –¥–µ–Ω—å (744 —á–∞—Å–∞)
- Storage: Filesystem (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
- Compaction: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### Promtail

–ö–æ–Ω—Ñ–∏–≥: `monitoring/promtail-config.yml`

–ü–∞—Ä—Å–∏–Ω–≥ JSON –ª–æ–≥–æ–≤:
```yaml
pipeline_stages:
  - json:
      expressions:
        timestamp: time
        level: level
        message: message
  - labels:
      level:
  - output:
      source: message
```

---

## üõ†Ô∏è Endpoints

| –°–µ—Ä–≤–∏—Å | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|-----|----------|
| Grafana | http://localhost:3000 | –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| Prometheus | http://localhost:9090 | –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∑–∞–ø—Ä–æ—Å—ã |
| Loki | http://localhost:3100 | API –ª–æ–≥–æ–≤ |
| Bot Metrics | http://localhost:8000/metrics | Prometheus –º–µ—Ç—Ä–∏–∫–∏ –±–æ—Ç–∞ |
| Bot Health | http://localhost:8000/health | Health check |

---

## üêõ –ê–ª–µ—Ä—Ç—ã (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ Grafana:

### –ü—Ä–∏–º–µ—Ä –∞–ª–µ—Ä—Ç–∞ "–í—ã—Å–æ–∫–∏–π Error Rate"

**–£—Å–ª–æ–≤–∏–µ:** –ë–æ–ª–µ–µ 5 –æ—à–∏–±–æ–∫ –≤ –º–∏–Ω—É—Ç—É
**–ó–∞–ø—Ä–æ—Å:**
```promql
sum(rate(bot_errors_total[1m])) * 60 > 5
```

### –ü—Ä–∏–º–µ—Ä –∞–ª–µ—Ä—Ç–∞ "–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã"

**–£—Å–ª–æ–≤–∏–µ:** 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å > 3 —Å–µ–∫—É–Ω–¥—ã
**–ó–∞–ø—Ä–æ—Å:**
```promql
histogram_quantile(0.95, sum(rate(bot_request_duration_seconds_bucket[5m])) by (le)) > 3
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∞:
1. –í –¥–∞—à–±–æ—Ä–¥–µ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–Ω–µ–ª—å
2. –ù–∞–∂–º–∏—Ç–µ **Edit** ‚Üí **Alert**
3. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ –∞–ª–µ—Ä—Ç–∞
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ notification channel (Email, Telegram, Slack –∏ –¥—Ä.)

---

## üì¶ Volumes –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

Docker volumes –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:
- `loki_data` - –î–∞–Ω–Ω—ã–µ –ª–æ–≥–æ–≤ Loki
- `prometheus_data` - –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
- `grafana_data` - –î–∞—à–±–æ—Ä–¥—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Grafana
- `postgres_data` - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞

### –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ volumes (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
docker-compose down -v

# –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ monitoring volumes
docker volume rm python_bot_loki_data
docker volume rm python_bot_prometheus_data
docker volume rm python_bot_grafana_data
```

---

## üîç Troubleshooting

### Grafana –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω:
```bash
curl http://localhost:8000/health
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –±–æ—Ç–∞:
```bash
curl http://localhost:8000/metrics
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Prometheus targets:
- –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:9090/targets
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å `schedulebot` target (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å UP)

### Loki –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –ª–æ–≥–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–æ–≥–∏ –ø–∏—à—É—Ç—Å—è:
```bash
tail -f logs/bot.log
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Promtail:
```bash
docker logs schedulebot_promtail
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Loki labels:
- –û—Ç–∫—Ä–æ–π—Ç–µ Grafana ‚Üí Explore ‚Üí Loki
- –ù–∞–∂–º–∏—Ç–µ "Log browser" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ labels

### –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

–ï—Å–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤:

1. –£–º–µ–Ω—å—à–∏—Ç–µ retention –≤ `prometheus.yml`:
```yaml
--storage.tsdb.retention.time=7d  # –≤–º–µ—Å—Ç–æ 30d
```

2. –£–º–µ–Ω—å—à–∏—Ç–µ retention –≤ `loki-config.yml`:
```yaml
retention_period: 168h  # 7 –¥–Ω–µ–π –≤–º–µ—Å—Ç–æ 31
```

3. –£–≤–µ–ª–∏—á—å—Ç–µ scrape interval –≤ `prometheus.yml`:
```yaml
scrape_interval: 30s  # –≤–º–µ—Å—Ç–æ 15s
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Prometheus Documentation](https://prometheus.io/docs/)
- [Loki Documentation](https://grafana.com/docs/loki/latest/)
- [Grafana Documentation](https://grafana.com/docs/grafana/latest/)
- [LogQL Reference](https://grafana.com/docs/loki/latest/logql/)
- [PromQL Reference](https://prometheus.io/docs/prometheus/latest/querying/basics/)

---

## üí° –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

1. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–∞—à–±–æ—Ä–¥—ã** –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã** –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ LogQL –¥–ª—è –¥–µ–±–∞–≥–∞** –≤–º–µ—Å—Ç–æ SSH –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
4. **–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–∏ –¥–∞—à–±–æ—Ä–¥—ã** –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã –ø—Ä–æ–µ–∫—Ç–∞
5. **–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã** –≤ JSON –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üéì –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –û—Ç–ª–∞–¥–∫–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

1. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana ‚Üí Explore
2. –í—ã–±–µ—Ä–∏—Ç–µ Prometheus
3. –ó–∞–ø—Ä–æ—Å:
```promql
topk(5, 
  histogram_quantile(0.95, 
    sum(rate(bot_request_duration_seconds_bucket[5m])) by (le, type)
  )
)
```

### –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å

1. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana ‚Üí Explore
2. –í—ã–±–µ—Ä–∏—Ç–µ Loki
3. –ó–∞–ø—Ä–æ—Å:
```logql
{job="schedulebot", level="ERROR"} | json
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –î–æ–±–∞–≤—å—Ç–µ user_id –≤ –ª–æ–≥–∏ (–≤ middleware/logging.py)
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä:
```logql
{job="schedulebot"} | json | user_id="123456"
```

### –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è

**–ö–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —á–∞—â–µ –≤—Å–µ–≥–æ:**
```promql
topk(10, sum(increase(bot_feature_usage_total[7d])) by (feature))
```

**–í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**
```promql
sort_desc(bot_active_users_by_hour)
```

**–ö–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–∞—è –≤–æ—Ä–æ–Ω–∫–∞:**
1. –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: `bot_total_private_chats`
2. –ó–∞–≤–µ—Ä—à–∏–ª–∏ tutorial: `bot_total_private_chats * (bot_tutorial_completion_rate / 100)`
3. –í—ã–±—Ä–∞–ª–∏ –≥—Ä—É–ø–ø—É: `bot_total_private_chats * (bot_group_selection_rate / 100)`

**Retention analysis:**
- –î–µ–Ω—å 1: `bot_returning_users_daily`
- –ù–µ–¥–µ–ª—è 1: `bot_returning_users_weekly`

---

–£–¥–∞—á–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞! üöÄ

